<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouTube Video Logger</title>
</head>
<body>
  <h2>Video Tracker Demo</h2>

  <!-- YouTube iframe -->
  <div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const videoId = "dQw4w9WgXcQ"; 
const ENDPOINT = "https://blue-sunset-9b47.akshay-n.workers.dev/";

let player;
let lastTime = 0;
let maxTime = 0;  // for completion %

function onYouTubeIframeAPIReady() {
  player = new YT.Player("player", {
    height: "360",
    width: "640",
    videoId,
    events: {
      "onReady": onPlayerReady,
      "onStateChange": onPlayerStateChange
    }
  });
}

function logEvent(eventType, timestamp, extraData="") {
  if(timestamp > maxTime) maxTime = timestamp;
  const duration = player ? player.getDuration() : 0;
  const completionPercent = duration > 0 ? (maxTime / duration) * 100 : 0;

  const body = JSON.stringify({
    eventType,
    videoId,
    timestamp,
    extraData,
    completionPercent
    // email is now handled by Apps Script
  });

  fetch(ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body
  }).then(res => res.json())
    .then(data => console.log("Logged:", data))
    .catch(err => console.error("Logging failed:", err));
}

function onPlayerReady(event) {
  setInterval(trackProgress, 5000); // log progress every 5s
}

function onPlayerStateChange(event) {
  const state = event.data;
  const currentTime = player.getCurrentTime();

  if(state === YT.PlayerState.PLAYING) logEvent("play", currentTime);
  if(state === YT.PlayerState.PAUSED) logEvent("pause", currentTime);
  if(state === YT.PlayerState.ENDED) logEvent("ended", currentTime);

  if(Math.abs(currentTime - lastTime) > 2) { // detect seek
    if(currentTime < lastTime) logEvent("seek-rewind", currentTime, `jump from ${lastTime} to ${currentTime}`);
    else logEvent("seek-forward", currentTime, `jump from ${lastTime} to ${currentTime}`);
  }

  lastTime = currentTime;
}

function trackProgress() {
  if(player && player.getPlayerState() === YT.PlayerState.PLAYING) {
    logEvent("progress", player.getCurrentTime());
  }
}
</script>
</body>
</html>
